<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>5ç¨®ã˜ã‚ƒã‚“ã‘ã‚“ LSTM AI</title>
    <style>
        /* --- åŸºæœ¬è¨­å®š --- */
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #f4f4f9;
            font-family: 'Helvetica Neue', Arial, sans-serif;
            color: #333;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100%;
            box-sizing: border-box;
            padding: 1vh 2vw;
        }

        /* --- ãƒ˜ãƒƒãƒ€ãƒ¼ --- */
        header {
            flex: 0 0 auto;
            text-align: center;
            margin-bottom: 1vh;
            position: relative;
        }
        h1 {
            margin: 0;
            font-size: 3.5vh;
            color: #2c3e50;
        }
        p.subtitle {
            margin: 0;
            font-size: 1.5vh;
            color: #666;
        }

        /* --- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ --- */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: row;
            gap: 2vw;
            min-height: 0;
        }

        /* å·¦ãƒ‘ãƒãƒ« */
        .status-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            padding: 1vh 2vh;
            text-align: center;
            position: relative;
            z-index: 10;
        }

        .status-text {
            font-size: 3.5vh;
            font-weight: bold;
            margin-bottom: 2vh;
            min-height: 1.2em;
        }

        .moves-display {
            display: flex;
            justify-content: space-around;
            margin-bottom: 1vh;
            align-items: flex-start;
        }
        .move-box {
            width: 45%;
            position: relative;
        }
        .move-label-header { font-size: 1.8vh; color: #777; margin-bottom: 0.5vh;}
        
        /* å‹è€…ãƒãƒ¼ã‚¯ */
        .winner-mark {
            position: absolute;
            top: -3vh;
            left: 50%;
            transform: translateX(-50%);
            background-color: #f1c40f;
            color: #d35400;
            font-weight: bold;
            font-size: 1.8vh;
            padding: 2px 10px;
            border-radius: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            opacity: 0;
            transition: opacity 0.3s, top 0.3s;
            white-space: nowrap;
        }
        .winner-mark.show { opacity: 1; top: -4vh; }

        .move-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 11vh;
        }
        .move-emoji { font-size: 6vh; line-height: 1.0; transition: transform 0.2s; }
        .move-text-sub { font-size: 2.2vh; font-weight: bold; color: #555; margin-top: 0.5vh; }


        /* å³ãƒ‘ãƒãƒ«ï¼ˆãƒãƒ£ãƒ¼ãƒˆï¼‰ */
        .chart-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            padding: 2vh;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }
        .chart-title { font-size: 2.2vh; margin-bottom: 1vh; }
        
        #chart-container {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        .chart-img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        /* --- ãƒ•ãƒƒã‚¿ãƒ¼ --- */
        footer {
            flex: 0 0 auto;
            padding-top: 2vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding-bottom: 8vh; 
        }

        .btn-group {
            display: flex;
            justify-content: center;
            width: 100%;
            gap: 1vw;
            margin-bottom: 1.5vh;
        }

        .move-btn {
            flex: 1;
            padding: 1.5vh 0;
            font-size: 2.2vh;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            color: white;
            transition: transform 0.1s;
            max-width: 18vw;
        }
        .move-btn:active { transform: scale(0.95); }
        
        .btn-gu { background-color: #e74c3c; }
        .btn-choki { background-color: #f1c40f; color: #333; }
        .btn-pa { background-color: #2ecc71; }
        .btn-king { background-color: #9b59b6; }
        .btn-slave { background-color: #34495e; }

        /* ãƒ¡ã‚¿æƒ…å ±ã‚¨ãƒªã‚¢ */
        .meta-info {
            margin-top: 1vh;
            font-size: 2.2vh;
            color: #444;
            display: flex;
            gap: 20px;
            align-items: center;
            justify-content: center;
            background-color: rgba(255,255,255,0.8);
            padding: 12px 30px;
            border-radius: 40px;
            flex-wrap: wrap;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        /* ãƒ•ãƒƒã‚¿ãƒ¼å†…ãƒœã‚¿ãƒ³ã®å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
        .footer-btn {
            padding: 1vh 2vh;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 2vh;
            color: white;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        .footer-btn:hover { opacity: 0.9; }

        .rule-btn { background-color: #3498db; }
        .story-btn { background-color: #e67e22; }
        .reset-btn { background-color: #7f8c8d; }


        /* --- ãƒ­ã‚´ (å††å½¢åˆ‡ã‚ŠæŠœã) --- */
        .logo-container {
            position: fixed;
            bottom: 15px;
            right: 15px;
            z-index: 100;
            opacity: 0.9;
            pointer-events: none;
        }
        .logo-img {
            width: 100px;
            height: 100px; /* æ­£å††ã«ã™ã‚‹ãŸã‚é«˜ã•ã‚‚å›ºå®š */
            object-fit: cover; /* ç”»åƒãŒã¤ã¶ã‚Œãªã„ã‚ˆã†ã«ãƒˆãƒªãƒŸãƒ³ã‚° */
            border-radius: 50%; /* å††å½¢ã«åˆ‡ã‚ŠæŠœã */
            display: block;
            background-color: white; /* ç”»åƒè‡ªä½“ã«é€æ˜éƒ¨åˆ†ãŒã‚ã£ãŸå ´åˆã®ä¿é™º */
            box-shadow: 0 2px 8px rgba(0,0,0,0.2); /* è»½ãå½±ã‚’ã¤ã‘ã¦æµ®ãä¸ŠãŒã‚‰ã›ã‚‹ */
        }

        /* --- ãƒ¢ãƒ¼ãƒ€ãƒ« (ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—) --- */
        .modal {
            display: none;
            position: fixed;
            z-index: 200;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }
        .modal.active { display: flex; }
        .modal-content {
            background-color: #fff;
            padding: 30px;
            border-radius: 15px;
            width: 80%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
        }
        .close-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            right: 20px;
            top: 10px;
        }
        .close-btn:hover { color: #000; }
        
        .modal-h2 { margin-top: 0; color: #2c3e50; border-bottom: 2px solid #eee; padding-bottom: 10px;}
        .rule-list li { margin-bottom: 8px; font-size: 1.8vh; }

        /* ã‚¹ãƒãƒ›ç¸¦æŒã¡ç”¨ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
        @media (max-aspect-ratio: 1/1) {
            .main-content { flex-direction: column; }
            .status-text { font-size: 3vh; margin-bottom: 1vh; }
            .move-emoji { font-size: 5vh; }
            .logo-img { width: 70px; height: 70px; }
            footer { padding-bottom: 10vh; } 
            .modal-content { width: 90%; padding: 20px; }
            .meta-info { font-size: 2vh; padding: 10px 15px; gap: 10px; }
            .footer-btn { font-size: 1.8vh; padding: 0.8vh 1.5vh; }
        }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>ğŸ‘‘ 5ç¨®ã˜ã‚ƒã‚“ã‘ã‚“ vs LSTM AI</h1>
            <p class="subtitle">AIã¯ã‚ãªãŸã®ç™–ã‚’å­¦ç¿’ã—ã¦å¼·ããªã‚Šã¾ã™</p>
        </header>

        <div class="main-content">
            <div class="status-panel">
                <div id="status" class="status-text">Ready?</div>
                
                <div class="moves-display">
                    <div class="move-box">
                        <div id="user-win-mark" class="winner-mark">ğŸ† WIN!</div>
                        <div class="move-label-header">ã‚ãªãŸ</div>
                        <div id="user-move" class="move-content">
                            <div class="move-emoji">-</div>
                            <div class="move-text-sub"></div>
                        </div>
                    </div>

                    <div style="font-size: 4vh; align-self: center; color:#ccc; padding-top: 2vh;">VS</div>

                    <div class="move-box">
                        <div id="ai-win-mark" class="winner-mark">ğŸ† WIN!</div>
                        <div class="move-label-header">AI</div>
                        <div id="ai-move" class="move-content">
                            <div class="move-emoji">-</div>
                            <div class="move-text-sub"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="chart-panel">
                <div class="chart-title">ğŸ§  AIãŒäºˆæ¸¬ã—ãŸã‚ãªãŸã®æ‰‹ã®ç¢ºç‡</div>
                <div id="chart-container">
                    <p style="color: #aaa; font-size: 2vh;">(ãƒ‡ãƒ¼ã‚¿åé›†ä¸­...)</p>
                </div>
            </div>
        </div>

        <footer>
            <div class="btn-group">
                <button class="move-btn btn-gu" onclick="play(0)">ğŸ‘Š<br>ã‚°ãƒ¼</button>
                <button class="move-btn btn-choki" onclick="play(1)">âœŒï¸<br>ãƒãƒ§ã‚­</button>
                <button class="move-btn btn-pa" onclick="play(2)">ğŸ–<br>ãƒ‘ãƒ¼</button>
                <button class="move-btn btn-king" onclick="play(3)">ğŸ‘‘<br>ç‹æ§˜</button>
                <button class="move-btn btn-slave" onclick="play(4)">ğŸ§‘â€ğŸŒ¾<br>è¾²æ°‘</button>
            </div>
            
            <div class="meta-info">
                <span>å¯¾æˆ¦æ•°: <span id="game-count">0</span></span>
                <span>å‹ç‡: <span id="win-rate">0.0</span>%</span>
                
                <button class="footer-btn rule-btn" onclick="openModal('rule-modal')">ğŸ“– ãƒ«ãƒ¼ãƒ«</button>
                <button class="footer-btn story-btn" onclick="openModal('dev-modal')">ğŸ¤« ãƒ’ãƒ³ãƒˆ</button>
                <button class="footer-btn reset-btn" onclick="resetGame()">ğŸ”„ ãƒªã‚»ãƒƒãƒˆ</button>
            </div>
        </footer>
    </div>

    <div class="logo-container">
        <img src="/static/logo.png" alt="Club Logo" class="logo-img" onerror="this.style.display='none'">
    </div>

    <div id="rule-modal" class="modal" onclick="closeModalOutside(event, 'rule-modal')">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('rule-modal')">&times;</span>
            <h2 class="modal-h2">ğŸ“– 5ç¨®ã˜ã‚ƒã‚“ã‘ã‚“ã®ãƒ«ãƒ¼ãƒ«</h2>
            <ul class="rule-list">
                <li><b>ğŸ‘‘ ç‹æ§˜</b> ã¯ã€ã‚°ãƒ¼ãƒ»ãƒãƒ§ã‚­ãƒ»ãƒ‘ãƒ¼ã™ã¹ã¦ã«å‹ã¡ã¾ã™ã€‚</li>
                <li><b>ğŸ§‘â€ğŸŒ¾ è¾²æ°‘</b> ã¯ã€ç‹æ§˜ã«ã ã‘å‹ã¡ã¾ã™ï¼ˆä¸‹å…‹ä¸Šï¼ï¼‰ã€‚</li>
                <li><b>ğŸ§‘â€ğŸŒ¾ è¾²æ°‘</b> ã¯ã€ã‚°ãƒ¼ãƒ»ãƒãƒ§ã‚­ãƒ»ãƒ‘ãƒ¼ã«ã¯è² ã‘ã¾ã™ã€‚</li>
                <li>ã‚°ãƒ¼ãƒ»ãƒãƒ§ã‚­ãƒ»ãƒ‘ãƒ¼åŒå£«ã¯é€šå¸¸ã®ãƒ«ãƒ¼ãƒ«ã§ã™ã€‚</li>
            </ul>
            <div style="text-align: center; margin-top: 20px; background: #f9f9f9; padding: 10px; border-radius: 8px;">
                <p style="margin:0; font-weight:bold;">æœ€å¼·æ‰‹: ç‹æ§˜</p>
                <p style="margin:5px 0 0 0; font-size: 0.9em;">ã—ã‹ã—ã€ä½¿ã„ã™ãã‚‹ã¨è¾²æ°‘ã«ç‹™ã‚ã‚Œã¾ã™...</p>
            </div>
        </div>
    </div>

    <div id="dev-modal" class="modal" onclick="closeModalOutside(event, 'dev-modal')">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('dev-modal')">&times;</span>
            <h2 class="modal-h2">ğŸ¤« ãƒ’ãƒ³ãƒˆã¨ã‚¦ãƒ©è©±</h2>
            <p>ã“ã®AIã¯ <b>LSTM (Long Short-Term Memory)</b> ã¨ã„ã†ãƒ‹ãƒ¥ãƒ¼ãƒ©ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚</p>
            <p>AIã¯ã‚ãªãŸã®ã€Œéå»ã®æ‰‹ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã€ã‚’è¨˜æ†¶ã—ã€å¸¸ã«ã€Œæ¬¡ã«æ¥ã‚‹æ‰‹ã€ã‚’äºˆæ¸¬ã—ã¦ã€ãã‚Œã«å‹ã¦ã‚‹æ‰‹ã‚’é¸ã‚“ã§ã„ã¾ã™ã€‚</p>
            
            <div style="background-color: #eafaf1; border-left: 5px solid #2ecc71; padding: 15px; margin: 20px 0;">
                <h3 style="margin-top:0; color:#27ae60;">ğŸ§ª å®Ÿé¨“ã—ã¦ã¿ã¦ãã ã•ã„</h3>
                <ul>
                    <li><b>ã€Œã‚°ãƒ¼ ğŸ‘Š â†’ ãƒãƒ§ã‚­ âœŒï¸ â†’ ãƒ‘ãƒ¼ ğŸ–ã€</b> ã®é †ç•ªã§ã€åŒã˜ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ä½•åº¦ã‚‚ç¹°ã‚Šè¿”ã—å‡ºã—ã¦ã¿ã¦ãã ã•ã„ã€‚æœ€åˆã¯è² ã‘ãŸã‚Šå‹ã£ãŸã‚Šã—ã¾ã™ãŒã€ä½•å‘¨ã‹ã™ã‚‹ã¨â€¦ï¼Ÿ</li>
                    <li><b>ã€Œç‹æ§˜ ğŸ‘‘ã€</b> ã‚’å¤šç”¨ã™ã‚‹ã¨ã€AIã®äºˆæ¸¬ã¯ã©ã†ãªã‚‹ã§ã—ã‚‡ã†ã‹ï¼Ÿ</li>
                    <li>ã‚ã‚‹æ™‚ã‹ã‚‰æ€¥ã«åŒã˜æ‰‹ã‚’å‡ºã—ç¶šã‘ã‚‹ã¨ï¼ŒAIã®äºˆæ¸¬ã¯ã©ã†å¤‰ã‚ã£ã¦ã„ãã§ã—ã‚‡ã†ã‹ï¼Ÿ</li>
                    <li>é€†ã«ã€ãƒ©ãƒ³ãƒ€ãƒ ã«æ‰‹ã‚’å‡ºã—ç¶šã‘ã‚‹ã¨ã€AIã¯ãªã‹ãªã‹å­¦ç¿’ã§ãã¾ã›ã‚“ã€‚</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        const EMOJI_MAP = {
            'ã‚°ãƒ¼': 'ğŸ‘Š',
            'ãƒãƒ§ã‚­': 'âœŒï¸',
            'ãƒ‘ãƒ¼': 'ğŸ–',
            'ç‹æ§˜': 'ğŸ‘‘',
            'å¥´éš·': 'ğŸ§‘â€ğŸŒ¾',
            'è¾²æ°‘': 'ğŸ§‘â€ğŸŒ¾' 
        };
        
        // å‹ç‡è¨ˆç®—ç”¨ã®å¤‰æ•°
        let localWinCount = 0;
        let localLoseCount = 0; // è² ã‘æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆã™ã‚‹å¤‰æ•°ã‚’è¿½åŠ 

        async function play(moveIndex) {
            try {
                const response = await fetch('/play', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ move: moveIndex })
                });
                const data = await response.json();

                let userMoveName = data.user_move_name;
                let aiMoveName = data.ai_move_name;
                if(userMoveName === 'å¥´éš·') userMoveName = 'è¾²æ°‘';
                if(aiMoveName === 'å¥´éš·') aiMoveName = 'è¾²æ°‘';

                const userEmoji = EMOJI_MAP[data.user_move_name] || 'â“';
                const aiEmoji = EMOJI_MAP[data.ai_move_name] || 'â“';

                document.getElementById('user-move').innerHTML = 
                    `<div class="move-emoji">${userEmoji}</div><div class="move-text-sub">${userMoveName}</div>`;
                document.getElementById('ai-move').innerHTML = 
                    `<div class="move-emoji">${aiEmoji}</div><div class="move-text-sub">${aiMoveName}</div>`;

                const resultText = data.result;
                const statusElem = document.getElementById('status');
                statusElem.innerText = resultText;

                document.getElementById('user-win-mark').classList.remove('show');
                document.getElementById('ai-win-mark').classList.remove('show');

                // --- å‹æ•—ã‚«ã‚¦ãƒ³ãƒˆãƒ­ã‚¸ãƒƒã‚¯ã®å¤‰æ›´ ---
                // ã‚ã„ã“ã®ã¨ãã¯ã‚«ã‚¦ãƒ³ãƒˆã—ãªã„
                if (resultText.includes("ã‚ãªãŸã®å‹ã¡")) {
                    statusElem.style.color = "#e74c3c";
                    document.getElementById('user-win-mark').classList.add('show');
                    localWinCount++;
                } else if (resultText.includes("AIã®å‹ã¡") || resultText.includes("è² ã‘")) {
                    statusElem.style.color = "#2980b9";
                    document.getElementById('ai-win-mark').classList.add('show');
                    localLoseCount++;
                } else {
                    statusElem.style.color = "#333";
                    // ã‚ã„ã“ãªã®ã§ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—ã—ãªã„
                }

                // --- å‹ç‡è¨ˆç®— (ã‚ã„ã“ã‚’é™¤å¤–) ---
                const validGames = localWinCount + localLoseCount;
                let winRate = "0.0";
                if (validGames > 0) {
                    winRate = (localWinCount / validGames * 100).toFixed(1);
                }
                document.getElementById('win-rate').innerText = winRate;
                
                // ç·å¯¾æˆ¦æ•°ã¯ã‚µãƒ¼ãƒãƒ¼å´ã®å€¤ã‚’è¡¨ç¤ºï¼ˆã‚ã„ã“ã‚‚å«ã‚€ï¼‰
                document.getElementById('game-count').innerText = data.games_count;

                const chartContainer = document.getElementById('chart-container');
                if (data.games_count <= 5) {
                    const remaining = 6 - data.games_count;
                    chartContainer.innerHTML = 
                        `<div style="text-align:center; color:#aaa;">
                            <p style="font-size:3vh;">ğŸ“‰ ãƒ‡ãƒ¼ã‚¿åé›†ä¸­...</p>
                            <p>AIã®äºˆæ¸¬é–‹å§‹ã¾ã§ã‚ã¨ <b>${remaining}</b> å›</p>
                        </div>`;
                } else if (data.chart_img) {
                    chartContainer.innerHTML = 
                        `<img src="data:image/png;base64,${data.chart_img}" class="chart-img" />`;
                }

            } catch (e) {
                console.error("é€šä¿¡ã‚¨ãƒ©ãƒ¼:", e);
            }
        }

        async function resetGame() {
            if(confirm("å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã¨æˆ¦ç¸¾ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")){
                await fetch('/reset', { method: 'POST' });
                localWinCount = 0;
                localLoseCount = 0;
                location.reload();
            }
        }

        function openModal(id) {
            document.getElementById(id).classList.add('active');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        function closeModalOutside(event, id) {
            if (event.target.classList.contains('modal')) {
                closeModal(id);
            }
        }
    </script>
</body>
</html>